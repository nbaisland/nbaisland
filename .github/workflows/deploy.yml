name: Deploy Backend to Pi

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Copy env file
        run: |
          cp $HOME/.env.nbaisland .env
      
      - name: Build and deploy with Docker Compose
        run: |
          docker compose down
          docker compose build
          docker compose up -d
      
      - name: Check health
        run: |
          sleep 10
          docker compose logs --tail 50
          curl -f http://localhost:8080/health || exit 1
      
      - name: Cleanup
        run: |
          docker image prune -f